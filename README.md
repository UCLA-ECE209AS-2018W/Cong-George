# ECE209AS Course project: House Occupacy Detection Via WiFi Packets Sniffing



## Abstract
In this paper we have demonstrated that we can infer the rough activity of a room/house(if there is someone at home or not) by snipping and parsing the wifi packets that are sent out by IoT devices such as Google home or Amazon Echo, and by mobile devices. We further demonstrated that even by parsing the informaiton contained in 802.11 mac frame header, we can create wifi signature of differnt device and infer the acticity within the house or home without decrypting wifi packet payload.
## Introduciton

As the concept of Internet of things are prevailing these days, more and more family choose to use them in house as a center of controll for other in-house IoT devices. For example, Google home can be associated with smart door lock or smart lamp for remote voice controll. While these devices greatly facilitate our daily life, it also exposes security issues.

To be more sepecific, devices such as Google Home, or Amazon Alexa will need to be connected to the network in order to fully enforce it's functionality. Even though nowadays the wifi packets are encrypted and are almost impossible to be decrypted, we still find a way to characterize different devices presented in the room by parsing the 802.11 frame headers which are not encrypted and can be analyzed automatically by tools such as whireshark. We demonstrate that by just using the information in the 802.11 frame header, we can form the wifi signature of differnt device. After we gathering enough informaiton and forming the signiture of each device, we can compare each new snipped wifi packet generated by unknow device and indentify possible known device by generating signatures from the new packet and compare it with exsiting signatures. Lastly, by how devices are detected within certain period, we can infer the room occupancy.   

## Background

As our approach relies on forming wifi signature from 802.11 frame heavily, we will be briefly going over the 802.11 frame header information as well as the concept of wifi signature. We assume that readers are familiar with network's osi 4-layer architecture as well as packet dumping tools such as wireshark. Also, we are assuming that readers are familiar with basic procedure of how devices can be connected to the network via access point(AP). We will also briefly introduce kali Linux operating system which is our wokring envirionment.

* **802.11 frame**    
802.11 frame is a header that is appened to the packets that are passed down from higher transport layer, information related to medium access control layer(MAC layer) will be added to the the header. All the realted data get passed down from the upper layer will be the payload of 802.11 frame and will be encrypted. However, the 802.11 frame header will not be encrypted and can be grabbed and parsed by tools such as wireshark. Let's take a look at the details of the contend of the header:  

![alt text][frame]

[frame]: https://github.com/UCLA-ECE209AS-2018W/Cong-George/blob/master/Screen%20Shot%202018-03-19%20at%201.02.36%20PM.png  

The information in the header contains both sender and receiver information as well as packet type and some other information you can refer to [this site](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc757419(v=ws.10)) for a detailed information, our approach only focuses on two specific type of packets: **probing packet(frame)** and **association packet(frame)** in MLME

* **WiFi Management Layer Identity(MLME)**  
MLME compromises a number of different types of packets with fixed parameters in 802.11 frame and are followed by other parameters suc as tagged parameters, optional fields. Also, different vendor will also add thier own parameters to the packet, which make packets sent by different devices easy of identify. Among all those MLME packets, our approach leverage the content of **Probe Frames** and **Association Frame**:  
**Probe frame**: sent by clients searching for an access point for any available AP, information included in the probe frame may be capabilites such as encodings, supported rates, authentication capabilities, supported MAC and so on.  
**Association frame**: sent by clients to ask the AP to add clients themselved to the WLAN.  
Our approach relies on these two frame to identify devices and infer house acticity.

* **WiFi Signature**  
In order for AP to handle probe and association request, AP examines the serires tagged parameters from clientsextracting those and used them as WiFi signatures. Since wifi signatures reflects a combination of the specific wifi chipset, device driver, WPA supplicant and PCB layout of the client device, they are capable of identidying differnt devices. The figure below shows the wifi signatures of differnt mobile phones.

![alt_text][frame1]

[frame1]:https://github.com/UCLA-ECE209AS-2018W/Cong-George/blob/master/sig.png  

## **Method**
As mentioned in the previous section, the approach we are adopting is first we will collect all the packets from any devices nearby, and from the 802.11 frame we will extract probe frame and assocaition frame to form the WiFi signature and identify the devices that send out probe and association frame most frequnctly within in a period time that is sufficiently long. After we have identify those devices, we will regard a house or room being occupied when those all those devices are actively sending probe and assotiation frames.

#### **Motivation**
Inspired by [Spying on the Smart Home: Privacy Attacks and Defenses on Encrypted IoT Traffic](https://arxiv.org/pdf/1708.05044.pdf), despite that information in 802.11 raw packets sniffed from the air is very well encrypted by latest WPA2 encrytion method and is very difficult to decrypted, personal privacy information can be still distilled from the encrypted packets traffic analysis. Although data contained in the upper layer of the packet are encrytpted, the ethernet (mac) layer and radio link information are transparent, giving sniffer the opportunity to learn the frame type, packet size and etc of a traffic from certain device in the network at any time. Depending on the hardware/software configuration and usage of a smart device, its traffic pattern may also vary accordingly. As discovered by researchers in [Is Anybody Home? Inferring Activity From Smart Home Network Traffic](http://ieeexplore.ieee.org/document/7527776/?reload=true), smart home devices collect, exchange, and transmit various data about the environment of our homes. This data can not only be used to characterize a physical property but also to infer personal information about the inhabitants. Traffic classification can be used as a source for covert channel attacks. Specifically, traffic classification techniques can infer events taking place within a building. 

#### **Traffic Classification Attempt**
Follow the trace of these related work, in the very beginning of this project, we seeked to infer the house occupancy from encypted 802.11 packet traffic classification. We tried to look for possible correlation between sniffed packets traffic pattern and smart device usage activities. Motivated by the method introduced in [Deep Packet: A Novel Approach For Encrypted Traffic Classification Using Deep Learning](https://arxiv.org/pdf/1709.02656.pdf), we adopted a similar approach - sniff 802.11 packets for a certain period of time and feed in features extracted from the traffic into a machine learning model for analysis. 

However, since we have no idea about the house host's living habbits, such as what smart devices he/she has, what applications they use and when to use it, traffic pattern could be totally different for different people. Even for the same person, his/her network usage may also change drastically due to many factors such as time of the day, weather and etc. Therefore, there is no way we could train a supervised machine learning model to perform the pattern classfication because simply we have no idea what the pattern would look like (this project will also be meaningless if we do know). Given this fact, a supervised deep learning model does not apply to our situation and we need a unsupervised machine learning model to classfy the network traffic. Therefore, we choosed a simple k-mean cluster model for the traffic analysis. After all, we only need the model to distinguish between two traffic pattern - when there is people home and when there is not, so k is simply equal to two. We also extract five feature such as number of data packets, number of devices,  number of null data packets and etc. These features will be calculated every 30 minutes and feed in the k-mean cluster model. At the end of the day, the model will finish its training and give out a pattern summary labeling the occupancy of each period (48 period in a day). 

[kmean]:

We spent the first few week to implement this method and the classfication result was horrible if not disastrous. Even after we tuning the model and facilitate the feature extraction process, the result still did not improve a bit. It turns out this naive traffic classfication attempt did not work as expected due to three major reasons:

* Inability to capture all data packets
Contrary to what we expected, wireless sniffing adapter is actually unable to capture all data packets directed from or to a ceratin device. This is because 802.11n has a special facility called "Greenfield" or "HT" (High throughput) mode that allows data to be transmitted between AP and device with ultra-high speed. We found this special facility is widely apadted in smart devices nowadays and data are transfering in between AP (router) and smart device such as cellphones with a speed higher than what our sniffing device could handle. Therefore, the data packets we captured only makes a very small fraction of total data transfer and most of data traffic were actually unobserved. We were only able to capture data packets that are not transferred via HT mode such as the three-way handshake process packets. Once connection is established, data will be transferred with a much higher rate which our adpater could not handle. Not to mentioned our adpator is reside in a rather noisy environment with in-the-air traffic from more than 20 devices at the same floor of my apartment building. This had been proved in our experiment - no obvious difference in the number of data packets between a idle and a highly active device. 

* Feature Dependency of the Unsupervised Clustering Model
Another major cause resides in features extracted from captured traffic. There are too much redundancy/dependency between features input to the machine learning model and thus leading to inaccuracy. For example, the feature "number of active device in network" has high dependency with the other feature "number of data packets". To be honest, there are very few features we could extracte from encrypted wifi traffic. In the sense that we use unsupervised models, there is no way to evaluate the feature importance and adjust weights accordingly. Furthermore, we can barely understand the metrics behind the clustering results. For example, although we expect the output two cluster representing time periods where people are at home or not, the actual underlying relationship between these two cluster could however indictate when is the target watching movies on laptop or not. 

* Network Activity Insufficient to Indicate House Occupancy
The fundamental reason that behind the failure of this approach is that we made a incorrect assumption about the relation between network traffic and house occupancy. Previously, we associate house occupancy with active network activity and naively assume active wifi traffic entails house occupancy and vise versa. Nevertheless, inactive traffic does NOT indicate house vacancy at all. Our clustering model always cluster night-time periods with actual vacant periods. It is highly likely that traffic pattern at nighttime where occupants of a house are not using smart device (sleeping) very much resembles periods when the house is actually vacant. Due to this observation, we finally realized that the traffic classfication approach is rather futile as network activity is a insufficient indicator of house occupancy.

#### **Cellphone Fingerprinting**
Rather focusing on traffic classfication, we later shifted to another approach - fingerprint all cellphones in the house. If any cellphone is detected in the network, then the house is not vacant and vise versa. This may rather sound like a very reckless claim, however, according to this [survey](http://www.pewinternet.org/2015/08/26/chapter-1-always-on-connectivity/), 92% American Adults own at least one cellphone and 67% of them are smartphones with Wifi capability. Furthermore, 90% of American adults carry cellphone with them wherever and about 80% of all adults never turn their cellphones off. Based on these numbers this survey, we believe the present of cellphone is a good indicator of house occupancy. Still there are a few assumptions we made for our approach to work as expected:

- The target house has a wifi AP (router)
- Occupants of target house have smartphones with wifi capabilities
- Occupants take cellphone with them when they leave the house
- Occupants do not turn off their cellphones at night and so remain in the network
- Smartphones of Occupants connect with house AP automatically

* Probe Request Monitoring
A very famous technique to fingerprint devices in the network is through probe request monitoring. Probe request frames as introduced in the background section, is one type of management frame which devices broadcast constantly in search for possible AP nodes to connect with. 



## **Implementation**
* **Hardware Setup**
* **Kali Linux Environment** 
* **WiFi Packets Sniffing**
* **WiFi Signature Extraction**
* **Occupancy Detection**

## **Results & Discussion**

## Future Work
One main direction of the fututure work would be migrating the task of traffic classification to machine learning based approch. This has advantage in various aspects. Given a proper model and architecture, the machine learing algorithm is much more powerful in extracting the features and finding correlations among all knids of traffic packets that are minglede together. This would be much more efficient than manually deciding and selecting features from frames. In addition, our design can only be applied to limited number of scenarios where the types of devices and network potocols across all layers of OSI is known, with ML model, we do not have to take care of potocols in advance, the model will do all the work for us.

## Current Related Work
- In paper **"Is Anybody Home? Inferring Activity From Smart Home Network Traffic"**, the researchers are trying to infer personal information by investigating device-to-device and device-to-cloud smart home network traffic. They are using traffic analysis techniques on network traffic generated by NEST thermostats to deduce information about the presence of residents and other events occurring within the property. They first collect traffic data and perform data filtering by MAC address and Organization Unique Identifier(OUI), after they have collected all the data they begin to learn the pattern of the data flow of each device by traffic classification and focusing on the connection size and correlation analysis as criterial for classification.

- In paper **"Spying on the Smart Home: Privacy Attacks and Defenses on Encrypted IoT traffic**, the researchers demonstrate that an ISP or other network observer can infer privacy sensitivity in-home activities even when the device use encryption. They further prove that even with encryption, smart home traffic attack is achievable with meta-data only. Their attack includes the use of DNS queries or device fingerprinting to identify smart home devices from network traffic and infer user activities from changes in the device traffic rate.

- In paper **"Deep packet, A Novel Approach For Encrypted Traffic Classification Using Deep Learning"**, the group propose a deep learning based approach for traffic classification that integrates both feature extraction and classification steps, their network is able to classify FTP and P2P network classes and can distinguish between VPN and non-VPN network thanks to the nature and extend of CNN. Also in the paper "Network Traffic Classification using Support Vector Machine and Artificial Neural Network" the group is exploring other methods in machine learning domain to perform an effective network traffic classification.

 - At last, to implement our design, we are following a tutorial called **"Everything generates data: Capturing WiFi anonymous traffic using Raspberry Pi and WSO2 BAM"** to collect WiFi packet in Kali Linux environment.  

## Reference


